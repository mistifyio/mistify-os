#!/bin/bash
#+
# Use this script to trigger a build on a Jenkins server for the working branch.
#-

jenkinsdefault=http://mistify-dev-2.office.omniti.com:8081
jenkinsjobdefault=MistifyOS-remote
mistifybranch=`git status | grep "On branch" | cut -f 3 -d ' '`

usage () {
    cat << EOF
Usage: $0 [options] [target]
  Use this script to remotely trigger a Mistify build on a Jenkins CI server.
  The Jenkins CI server must be configured to run the buildmistify script on the
  server in order to build.
  Options:
    ==== remote build ====
    --jenkins <URL>
        The Jenkins CI server URL. The URL is saved in the file
        $statedir/jenkins.
        [jenkins=`cat $statedir/jenkins`]
    --job <JOB>
        The job to execute. This must match a name in the Jenkins job list. This
        is saved in the file: $statedir/job
        [job=`cat $statedir/job`]
        Parameters passed to the Jenkins server:
        [branch=$mistifybranch]
    ==== other ====
    --dryrun
        Just testing what will happen with this script. Don't run the Buildroot
        make.
    -h|--help
        Display this usage.

  NOTE: This script maintains state in $statedir.
EOF
}

source scripts/mistify-functions.sh

#+
# Handle the command line options.
#-
a=`getopt -l "\
jenkins:,\
job:,\
dryrun,\
help" \
   -o "h" -- "$@"`

if [ $? -gt 0 ]; then
    usage
    exit 1
fi

eval set -- $a

while [ $# -ge 1 ]; do
    case "$1" in
	--)
	    shift
	    options=$*
	    break
	    ;;
	--jenkins)
	    jenkins=$2
	    shift
	    ;;
	--job)
	    job=$2
	    shift
	    ;;
	--dryrun)
	    dryrun=y
	    ;;
	-h|--help)
	    usage
	    exit 0
	    ;;
	# using getopt should avoid needing this catchall but just in case...
	*)
	    error "Invalid option: $1"
	    usage
	    exit 1
	    ;;
    esac
    shift
done

if [ -z "$jenkins" ]; then
    if [ -f $statedir/jenkins ]; then
	jenkins=`cat $statedir/jenkins`
    else
	jenkins=$jenkinsdefault
    fi
fi
echo $jenkins >$statedir/jenkins

if [ -z "$job" ]; then
    if [ -f $statedir/job ]; then
	job=`cat $statedir/job`
    else
	jenkins=$jenkinsdefault
    fi
fi
echo $jenkins >$statedir/jenkins

if [ -n "$options" ]; then
  message "Options are: $options"
  params="&options="
  params+=`echo $options | sed 's/ /%20/g'`
  message "Adding Jenkins parameters: $params"
fi

jenkinscommand="wget -O /dev/null $jenkins/job/$job/buildWithParameters?token=buildmistify&branch=$mistifybranch$params"

if [ -n "$dryrun" ]; then
  message "Just a test run -- not building."
  message $jenkinscommand
  exit 0
fi

message "Triggering a remote build on Jenkins server: $jenkins"
message "The branch is: $mistifybranch"
$jenkinscommand
if [ $? -gt 0 ]; then
  error The Jenkins server is not running at the URL or did not accept the job.
  exit 1
fi
